<!DOCTYPE html>
<html>

<head>
  <title>Bay Trail</title>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <style>
    body {
      margin: 0;
      padding: 15px;
      overflow-y: hidden;
      height: 100vh;
    }

    html,
    body {
      /*height: 100%;*/
    }

    #map {
      overflow-y: hidden;
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:300,300i,400,400i,500,500i,700,700i&display=swap"
    rel="stylesheet">
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.css' rel='stylesheet' />
  <link href='style.css' rel='stylesheet' />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>
  <div class="welcome-modal" id="Welcome">
    <div class="welcome-modal-header">
      <button onclick="clouseModalWelcome()">&#10006;</button>
    </div>
    <p>
      Hello. Weâ€™ve added new features to the Bay Trail interactive map.
    </p>
    <p style="margin: 0px;">
      Click or tap trail segments for length, type, and local area information.
    </p>
  </div>
  <div id="accordion" class="baytrail-legend-body">
    <div class="card">
      <div class="card-header" id="headingOne">
        <button class="collapsible collapsed" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false"  aria-controls="collapseOne">
          Legend
        </button>
      </div>
      <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordion">
        <div class="card-body">
          <div id="accordion1">
            <div class="card">
              <div class="card-header" id="headingOne1">
                <button class="collapsible-trails" data-toggle="collapse" data-target="#collapseOne1"  aria-expanded="true" aria-controls="collapseOne1">
                  TRAILS
                </button>
              </div>
              <div id="collapseOne1" class="collapse show" aria-labelledby="headingOne1" data-parent="#accordion1">
                <div class="card-body">
                  <div class="content-trails">
                    <h3>Bay Trail</h3>
                    <dl>
                      <dt>
                        <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
                          <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#265a3b" />
                        </svg>
                      </dt>
                      <dd>Paved</dd>
                      <dt>
                        <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
                          <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#70c05e" />
                        </svg>
                      </dt>
                      <dd>Dirt/Gravel</dd>
                      <dt>
                        <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
                          <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#265a3b" />
                          <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:2.5;stroke:#70c05e" />
                        </svg>
                      </dt>
                      <dd>On Street</dd>
                      <dt>
                        <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
                          <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#70c05e;stroke-dasharray:4,3" />
                        </svg>
                      </dt>
                      <dd>Planned</dd>
                    </dl>
                    <h3 class="other-title">Other Trail</h3>
                    <dl>
                      <dt>
                        <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
                          <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#9c70da" />
                        </svg>
                      </dt>
                      <dd>Existing</dd>
                      <dt>
                        <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
                          <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#9c70da;stroke-dasharray:4,3" />
                        </svg>
                      </dt>
                      <dd>Planned</dd>
                    </dl>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="card-header" id="headingTwo">
                <button class="collapsible-trails collapsed" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                  ICONS
                </button>
              </div>
              <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordion1">
                <div class="card-body">
                  <div class="content-trails">
                    <dl>
                      <dt>
                        <span class="icon">&#9632;</span>
                      </dt><dd>Point of Interest</dd>
                      <dt>
                        <span class="icon train"></span>
                      </dt><dd>Train Station</dd>
                      <dt>
                        <span class="icon icon-p">&#x50;</span>
                      </dt><dd>Parking</dd>
                      <dt>
                        <span class="icon boat"></span>
                      </dt><dd>Marina/Boating</dd>
                      <dt>
                        <span class="icon fishing"></span>
                      </dt><dd>Fishing</dd>
                    </dl>
                    <p class="note">
                      Note: Zoom in if you don't currently see icons
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- <div class="popup-one">
    <h1>BAY TRAIL SEGMENT</h1>
    <h2>Aquatic Park and Fort Mason</h2>
    <hr class="green-line">
    </hr>
    <p>Paved</p>
    <p>0.36 miles</p>
    <p class="opacity-text">Read more:</p>
    <p class="more-text">Map By Numbers: Map 1 &#8213;
      San Fransisco Northern
      Waterfront</p>
  </div> -->
  <div id='map' class="map"></div>

  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.11.0/mapbox-gl.js'></script>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
  <script type="text/javascript" src="constants.js" ></script>
  <script>

    function clouseModalWelcome() {
      document.getElementById("Welcome").style.display = "none";
    }
    function separator(numb) {
      var str = numb.toString().split(".");
      str[0] = str[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return str.join(".");
    }
    // var coll = document.getElementsByClassName("collapsible");

    // for (var i = 0; i < coll.length; i++) {
    //   coll[i].addEventListener("click", function () {
    //     this.classList.toggle("active");
    //     var content = this.nextElementSibling;
    //     if (content.style.maxHeight) {
    //       content.style.maxHeight = null;
    //     } else {
    //       content.style.maxHeight = content.scrollHeight + "px";
    //     }
    //   });
    // }
    // var collTrails = document.getElementsByClassName("collapsible-trails");

    // for (var i = 0; i < collTrails.length; i++) {
    //   collTrails[i].addEventListener("click", function () {
    //     this.classList.toggle("active");
    //     var content = this.nextElementSibling;
    //     if (content.style.maxHeight !== null) {
    //       content.style.maxHeight = content.scrollHeight + "px";
    //     } else {
    //       content.style.maxHeight = null;
    //     }
    //   });
    // }

    class LegendControl {
      constructor({ container = null } = {}) {
        this._container = container;
      }

      onAdd(map) {
        this._map = map;
        if (!this._container) this._container = this._map.getContainer();
        this._controlContainer = document.createElement('div');
        this._controlContainer.classList = `mapboxgl-ctrl mapboxgl-ctrl-group mapboxgl-ctrl-legend`;
        this.constructUI();
        return this._controlContainer;
      }

      onRemove() {
        this._controlContainer.remove();
        this._map = null;
      }

      constructUI() {
        this._controlContainer.innerHTML = `
      <div class="baytrail-legend">
        <h3>Bay Trail</h3>
        <dl>
          <dt>
            <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
              <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#265a3b"/>
            </svg>
          </dt><dd>Paved (off street)</dd>

          <dt>
            <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
              <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#70c05e"/>
            </svg>
          </dt><dd>Dirt/Gravel</dd>

          <dt>
            <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
              <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#265a3b"/>
              <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:2.5;stroke:#70c05e"/>
            </svg>
          </dt><dd>On Street</dd>

          <dt>
            <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
              <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#70c05e;stroke-dasharray:4,3"/>
            </svg>
          </dt><dd>Planned</dd>
        </dl>
        <h3>Other Trail</h3>
        <dl>
          <dt>
            <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
              <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#9c70da"/>
            </svg>
          </dt><dd>Existing</dd>

          <dt>
            <svg width="25" height="5" viewBox="0 0 25 5" class="baytrail-legendLine">
              <line x1="0" x2="25" y1="2.5" y2="2.5" style="stroke-width:5;stroke:#9c70da;stroke-dasharray:4,3"/>
            </svg>
          </dt><dd>Planned</dd>
        </dl>
      </div>
    `;
      }
    }
    $('.collapsible').on('click', function() {
      $(this).find('i').toggleClass('fa-arrow-down fa-arrow-up');
    });
    class MeasurementOutput {
      constructor({ container = null } = {}) {
        this._container = container;
        this._tempDistance = 0;
        this._distance = 0;
      }

      onAdd(map) {
        this._map = map;
        if (!this._container) this._container = this._map.getContainer();
        this._controlContainer = document.createElement('div');
        this._controlContainer.classList = 'mapboxgl-ctrl mapboxgl-ctrl-group';

        this._controlContainer.style.cssText = `
    padding: 0 8px;
    color: white;
    min-width: 100px;
    text-align: center;
    background-color: rgb(0 0 0/70%);
    box-shadow: 0 0 0 2px rgb(0 0 0/80%);
    `;

        this._controlContainer.textContent = 'Distance: 0.00 miles';
        return this._controlContainer;
      }

      onRemove() {
        this._controlContainer.remove();
        this._map = null;
      }

      _updateDistanceText() {
        const dist = this._distance + this._tempDistance;
        this._controlContainer.textContent = `Distance: ${dist.toFixed(2)} miles`;
      }

      set distance(value) {
        this._distance = value;
        this._updateDistanceText();
      }
      set tmpDistance(value) {
        this._tempDistance = Number.isNaN(value) ? 0 : value;
        this._updateDistanceText();
      }
    }

    class MeasureControl {
      constructor({ container = null } = {}, popup ) {
        this._container = container;
        this._enabled = false;
        this._coordinates = [];
        this._popup = popup;
        // Temporary coordiantes, to be updated quickly as mouse hover moves
        this._tmpCoordinates = [[0, 0], [0, 0]];

        // When finalized, clicks start a new path
        this._finalized = false;
      }

      onAdd(map) {
        this._map = map;
        if (!this._container) this._container = this._map.getContainer();
        this._controlContainer = document.createElement('div');
        this._controlContainer.classList = 'mapboxgl-ctrl mapboxgl-ctrl-group mapboxgl-ctrl-measure';
        this.constructUI();

        this._map.addSource('measurement-path', {
          type: 'geojson',
          data: {
            type: 'LineString',
            coordinates: this._coordinates
          }
        });

        this._map.addSource('measurement-tmp-path', {
          type: 'geojson',
          data: {
            type: 'LineString',
            coordinates: [[0, 0], [0, 0]],
          }
        });

        this._map.addSource('measurement-vertices', {
          type: 'geojson',
          data: {
            type: 'FeatureCollection',
            features: this._coordinates.map((coordinates, id) => ({
              type: 'Feature',
              properties: {
                id: id
              },
              geometry: {
                type: 'Point',
                coordinates
              }
            }))
          }
        });

        this._map.addLayer({
          id: 'measurement-path-vertices-border',
          source: 'measurement-vertices',
          type: 'circle',
          paint: {
            'circle-radius': [
              'case',
              ['boolean', ['feature-state', 'hover'], false],
              7,
              5
            ],
            'circle-color': '#112288'
          }
        });

        this._map.addLayer({
          id: 'measurement-path-line-casing',
          source: 'measurement-path',
          type: 'line',
          paint: {
            'line-width': 5,
            'line-color': '#112288'
          },
          layout: {
            'line-join': 'round',
            'line-cap': 'round',
          }
        });

        this._map.addLayer({
          id: 'measurement-path-line',
          source: 'measurement-path',
          type: 'line',
          paint: {
            'line-width': 3,
            'line-color': '#3388ff'
          },
          layout: {
            'line-join': 'round',
            'line-cap': 'round',
          }
        });

        this._map.addLayer({
          id: 'measurement-tmp-path-line',
          source: 'measurement-tmp-path',
          type: 'line',
          paint: {
            'line-width': 3,
            'line-color': '#3388ff',
            'line-dasharray': [1, 2],
          },
          layout: {
            'line-join': 'round',
            'line-cap': 'round',
          }
        });

        this._map.addLayer({
          id: 'measurement-path-vertices',
          source: 'measurement-vertices',
          type: 'circle',
          paint: {
            'circle-radius': [
              'case',
              ['boolean', ['feature-state', 'hover'], false],
              6,
              4
            ],
            'circle-color': 'white'
          },
          layout: {
          }
        });

        return this._controlContainer;
      }

      onRemove() {
        this._disableMeasurement();
        this._map.removeLayer('measurement-path-line');
        this._map.removeLayer('measurement-path-line-casing');
        this._map.removeSource('measurement-path');
        this._controlContainer.remove();
        this._map = null;
      }

      constructUI() {
        const toggle = document.createElement('button');
        toggle.setAttribute('title', 'Measure path');
        const icon = this.createIcon();
        toggle.appendChild(icon);

        toggle.addEventListener('click', this._toggleMeasurement.bind(this));
        this._controlContainer.appendChild(toggle);

        const toggleFinish = document.createElement('button');
        toggleFinish.setAttribute('title', 'Finish Button');
        toggleFinish.setAttribute('id', 'finishbutton');
        toggleFinish.setAttribute('style', `
          display: none;
          left: 38px;
          position: absolute;
          background: #3388ff;
          color: white;
          font-weight: 700;
          top: 0px;
          width: 59px;
          border-radius: 4px;
          border: 1px solid #ddd;`
        );
        
        // toggleFinish.style.cssText();        
        toggleFinish.textContent = 'Finish';
        toggleFinish.addEventListener('click', this.finalizePath.bind(this) );

        this._controlContainer.appendChild(toggleFinish);

      }

      createIcon() {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('d', 'M6,2L18,14L14,18L2,6Z M16,12L14,14 M14,10L13,11 M12,8L10,10 M10,6L9,7 M8,4L6,6');
        path.setAttribute('stroke-width', '0.8px');
        path.setAttribute('stroke', 'black');
        path.setAttribute('fill', '#e0e0ee');
        svg.setAttribute('width', 24);
        svg.setAttribute('height', 24);
        svg.setAttribute('viewBox', '0 0 20 20');
        svg.appendChild(path);
        return svg;
      }

      finalizePath() {
        if (!this._measurementOutput) {
          return;
        }
        this._finalized = true;
        this._tmpCoordinates = [[0, 0], [0, 0]];
        this._measurementOutput.tmpDistance = 0;
        this._updateTmpPath();
        this._updatePath();
        this._toggleMeasurement();
      }

      newPath() {
        this._finalized = false;
        this._coordinates.length = 0;
      }

      _toggleMeasurement() {
        this._enabled = !this._enabled;
        this._coordinates.length = 0;

        if (this._enabled) {
          this._enableMeasurement();
        } else {
          this._disableMeasurement();
        }
        this._setCursor();
      }

      _enableMeasurement() {
        document.getElementById('finishbutton').style.display = 'unset';
        this._controlContainer.classList.add('active');
        this._map.setLayoutProperty('measurement-path-line', 'visibility', 'visible');
        this._map.setLayoutProperty('measurement-path-line-casing', 'visibility', 'visible');
        this._map.setLayoutProperty('measurement-tmp-path-line', 'visibility', 'none');
        this._tmpCoordinates = [[NaN, NaN], [0, 0]]

        this._handleClickPopup = event => {
          event.preventDefault();
          console.log('_finalized', this._finalized);
          if ( this._finalized ) {
            const features = map.queryRenderedFeatures(event.point, {
              layers: [
                'measurement-tmp-path-line',
                'measurement-path-line',
                'measurement-path-line-casing'
              ]
            });
            const distanceMiles = this._measurementOutput._distance;
            const MILESTOFEET = 5280;
            const distanceFeet = distanceMiles ? distanceMiles * MILESTOFEET : 0;
            let html = `
            <div class="popup-one">
              <h1>LINE MEASUREMENT</h1>
              <p class="label-name">Distance: </p>
              <h2>  {{feet}} feet ({{miles}} miles)</h2>
              <button id='deletebutton' class="btn-trash"><span class="ico trash""></span> Delete </button>
            </div>
            `;
            html = html.replace('{{feet}}', separator(distanceFeet.toFixed(0)));
            html = html.replace('{{miles}}', distanceMiles.toFixed(2));

            this._popup.setLngLat(event.lngLat)
              .setHTML(html)
              .addTo(this._map);
            document.getElementById('deletebutton')?.addEventListener('click',this._deleteDrawnLine.bind(this))

          }
        }
        this._handleClick = event => {
          event.preventDefault();
          if (this._finalized) {
            this.newPath();
          } else {
            // If the path is not finalized, then a click on the last-appended point finalizes the path
            const features = map.queryRenderedFeatures(event.point, {
              layers: ['measurement-path-vertices']
            });
            // If the clicked point is the last point of the path, then close the path
            for (const feature of features) {
              if (feature.id === this._coordinates.length - 1) {
                this.finalizePath();
                return;
              }
            }
          }

          // If not a click on a point, then proceed as normal with appending a point to the
          // measurement path
          this._coordinates.push([event.lngLat.lng, event.lngLat.lat]);
          this._tmpCoordinates = [
            [event.lngLat.lng, event.lngLat.lat],
            [event.lngLat.lng, event.lngLat.lat]
          ];
          this._measurementOutput.tmpDistance = 0;
          this._updatePath();
          this._updateTmpPath();
          this._setCursor();
          this._map.setLayoutProperty('measurement-tmp-path-line', 'visibility', 'visible');

          map.setFeatureState({
            source: 'measurement-vertices',
            id: this._coordinates.length - 1
          }, {
            hover: true
          });
        };

        const activeHoverFeatureIds = [];
        this._handleMouseMove = event => {
          const features = map.queryRenderedFeatures(event.point, {
            layers: ['measurement-path-vertices']
          });
          for (const feature of features) {
            activeHoverFeatureIds.push(feature.id);
            map.setFeatureState({
              source: 'measurement-vertices',
              id: feature.id
            }, {
              hover: true
            });
          }

          if (this._finalized) return;
          this._tmpCoordinates[1] = [event.lngLat.lng, event.lngLat.lat];
          this._measurementOutput.tmpDistance = turf.length({
            type: 'LineString',
            coordinates: this._tmpCoordinates
          });
          this._updateTmpPath();
        };

        this._handleLeaveFeature = event => {
          while (activeHoverFeatureIds.length) {
            const id = activeHoverFeatureIds.pop();
            map.setFeatureState({
              source: 'measurement-vertices',
              id: id
            }, {
              hover: false
            });
          }
        };

        this._measurementOutput = new MeasurementOutput();
        this._map.addControl(this._measurementOutput, 'top-right');

        this._map.on("mouseenter", ['measurement-path-line'], () => {
          map.getCanvas().style.cursor = "pointer";
        });

        this._map.on("mouseleave", ['measurement-path-line'], () => {
          map.getCanvas().style.cursor = "";
        });
        this._map.off('click', 'measurement-path-line', this._handleClickPopup);
        this._map.on('click', this._handleClick);
        this._map.on('mousemove', this._handleMouseMove);
        this._map.on('mouseleave', 'measurement-path-vertices', this._handleLeaveFeature);
      }

      _disableMeasurement() {
        document.getElementById('finishbutton').style.display = 'none';
        this._controlContainer.classList.remove('active');
        this._map.off('click', this._handleClick);
        this._map.off('mousemove', this._handleMouseMove);
        this._map.on('click', 'measurement-path-line', this._handleClickPopup);
        // COMMENTED TO PREVENT DELETE MEASURE LINE IN ORDER TO ADD POPUP
        // this._map.setLayoutProperty('measurement-path-line', 'visibility', 'none');
        // this._map.setLayoutProperty('measurement-path-line-casing', 'visibility', 'none');
        // this._map.setLayoutProperty('measurement-tmp-path-line', 'visibility', 'none');
        this._map.removeControl(this._measurementOutput);
        // this._measurementOutput = null;
        this._setCursor();
        // this._updatePath();
      }
      _deleteDrawnLine() {
        console.log('about to remove');
        this._map.setLayoutProperty('measurement-path-line', 'visibility', 'none');
        this._map.setLayoutProperty('measurement-path-line-casing', 'visibility', 'none');
        this._map.setLayoutProperty('measurement-tmp-path-line', 'visibility', 'none');
        this._measurementOutput = null;
        this._updatePath();
        this._popup.remove();
      }

      _updateTmpPath() {
        this._map.getSource('measurement-tmp-path').setData({
          type: 'LineString',
          coordinates: this._tmpCoordinates
        });
        map.triggerRepaint();
      }

      _updatePath() {
        const lineString = {
          type: 'LineString',
          coordinates: this._coordinates
        }
        this._map.getSource('measurement-path').setData(lineString);

        this._map.getSource('measurement-vertices').setData({
          type: 'FeatureCollection',
          features: this._coordinates.map((coordinates, id) => ({
            type: 'Feature',
            id: id,
            properties: {},
            geometry: {
              type: 'Point',
              coordinates
            }
          }))
        });

        if (this._measurementOutput) this._measurementOutput.distance = turf.length(lineString);
        map.triggerRepaint();
      }

      _setCursor() {
        if (this._enabled) {
          map.getCanvas().style.cursor = 'crosshair';
        } else {
          map.getCanvas().style.cursor = '';
        }
      }
    }

    class BayTrailMap {
      constructor({ mapboxgl, accessToken, container }) {
        this.mapboxgl = mapboxgl;
        this.map = window.map = new this.mapboxgl.Map({
          container,
          accessToken,
          style: 'mapbox://styles/rreusser/cl8opuxyd000014qgjao6pono',
          hash: false,
          logoPosition: 'top-right',
          bounds: [[-122.75, 37.3], [-121.8, 38.3]],
          fitBoundsOptions: {
            padding: 30
          },
          maxBounds: [
            [-126, 35],
            [-119, 41]
          ],
        });

        map.once('load', () => {
          this.popup = new this.mapboxgl.Popup();
          this.measurePopup = new this.mapboxgl.Popup();

          this.metricScaleControl = new this.mapboxgl.ScaleControl({ unit: 'metric' });
          this.imperialScaleControl = new this.mapboxgl.ScaleControl({ unit: 'imperial' });
          map.addControl(this.metricScaleControl, 'top-right');
          map.addControl(this.imperialScaleControl, 'top-right');

          this.navControl = new this.mapboxgl.NavigationControl()
          map.addControl(this.navControl, 'top-left');

          this.locateUserControl = new this.mapboxgl.GeolocateControl();
          map.addControl(this.locateUserControl, 'top-left');

          this.fullscreenControl = new this.mapboxgl.FullscreenControl();
          map.addControl(this.fullscreenControl, 'top-left');

          this.legendControl = new LegendControl();
          map.addControl(this.legendControl, 'bottom-left');

          this.measureControl = new MeasureControl( undefined , this.measurePopup);
          map.addControl(this.measureControl, 'top-left');

          addSource(this.popup);
        });
      }
    }

    function addSource(popup) {
      responseGeojson().then(res => {
        map.addSource('sf_baytrail', {
          type: 'geojson',
          data: res
        });
        map.addLayer({
          id: 'bayTrailLayer',
          source: 'sf_baytrail',
          type: 'line',
          paint: {
            'line-width': 3,
            'line-color': 'transparent'
          },
          layout: {

          }
        });
        map.on("mouseenter", ['bayTrailLayer'], () => {
          map.getCanvas().style.cursor = "pointer";
        });

        map.on("mouseleave", ['bayTrailLayer'], () => {
          map.getCanvas().style.cursor = "";
        });

        map.on('click', ['bayTrailLayer'], (e) => {
          let html = `
          <div class="popup-one">
                <h1>{{MAINTITLE}}</h1>
                <h2>{{location}}</h2>
                <hr class="{{classline}}">
                </hr>
                {{SURFACE}}
                <p>{{length}} miles</p>
                <p class="opacity-text">Read more:</p>
                <p class="more-text">
                  <a href="https://mtc.ca.gov/operations/regional-trails-parks/san-francisco-bay-trail/map-numbers/{{link}}" target="_blank">{{maptitle}}</a>
                </p>
                <p class="opacity-text">SegNo: {{SEG_NUM}}</p>
              </div>
          `;
          
          let maintitle = 'BAY TRAIL SEGMENT';
          // <hr class="green-line">
          //       <hr class="green-line light-green-line"></hr>
          //       <hr class="green-line green-green-line"></hr>
          //       <hr class="green-line pruple-line"></hr>
          console.log('features prop', e.features[0]);
          
          const SEG_NUM = e.features[0].properties.SEG_NUM;
          const mapValue = maptitles[mapkeys[SEG_NUM]];
          const LEGEND = e.features[0].properties.LEGEND;
          const SURFACE = e.features[0].properties.SURFACE;
          let SURFACEVALUE = '<p>{{value}}</p>'
          let strValue = e.features[0].properties.SURFACE;
          if (LEGEND === 'Bay Trail (off street)') {
            if (SURFACE === 'paved') {
              classline = 'green-line';
              strValue = 'Paved';
            } else {
              classline = 'green-line light-green-line';
              strValue = 'Dirt/Gravel';
            }
          } else if (LEGEND === 'Bay Trail (on street)' && SURFACE === 'paved')  {
            classline = 'green-line green-green-line';
            strValue = 'On Street';
          } else if( LEGEND === 'Other Trail') {
            classline = 'green-line pruple-line';
            strValue = 'Existing';
            maintitle = 'OTHER TRAIL SEGMENT';
          } else if ( LEGEND === 'Planned Other Trail') {
            classline = 'green-line purple-dots';
            strValue = 'Planned';
            maintitle = 'OTHER TRAIL SEGMENT';
          } else if ( LEGEND === 'Planned Bay Trail') {
            classline = 'green-line green-dots';
            strValue = 'Planned';
          }
          html = html.replace('{{link}}', mapValue.link);
          html = html.replace('{{maptitle}}', mapValue.title);
          html = html.replace('{{MAINTITLE}}', maintitle);
          html = html.replace('{{classline}}', classline);
          html = html.replace('{{location}}', e.features[0].properties.Location)

          html = html.replace('{{SURFACE}}', SURFACEVALUE.replace('{{value}}', strValue));
          html = html.replace('{{length}}', (e.features[0].properties.Length).toFixed(2))
          html = html.replace('{{SEG_NUM}}', e.features[0].properties.SEG_NUM)
          popup.setLngLat(e.lngLat)
            .setHTML(html)
            .addTo(map)
        })
      })
    }

    function responseGeojson() {
      return (fetch('sf_baytrail_aug2022_wgs84.geojson')
        .then(res => res.json()))
    }

    const bayTrailMap = new BayTrailMap({
      mapboxgl: window.mapboxgl,
      container: document.getElementById('map'),
      accessToken: 'pk.eyJ1IjoiYmF5dHJhaWwiLCJhIjoiY2w4MHM3ZGF4MDh2czNubGpocDhybGIzcyJ9.rHx3m7svLRuRY33DhysV1g'
    });

  </script>
</body>

</html>